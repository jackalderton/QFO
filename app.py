from fastapi import FastAPI, UploadFile, File, HTTPException, Query
from fastapi.responses import JSONResponse
from fastapi.middleware.cors import CORSMiddleware

import os
import io
import re
import math
import numpy as np
import pandas as pd
import trafilatura

from functools import lru_cache
from typing import List, Dict, Tuple, Any

# -----------------------------
# Local Embedding + Fanout Models
# -----------------------------

EMBED_MODEL_PATH = os.getenv("EMBED_MODEL_NAME", "/models/all-MiniLM-L6-v2")
FANOUT_MODEL_PATH = os.getenv("FANOUT_MODEL_NAME", "/models/flan-t5-small")

from sentence_transformers import SentenceTransformer
from transformers import AutoTokenizer, AutoModelForSeq2SeqLM

import torch
from sklearn.feature_extraction.text import ENGLISH_STOP_WORDS

# -----------------------------
# Scoring Constants
# -----------------------------

W_SIM_DEFAULT = 0.6
W_COV_DEFAULT = 0.25
W_ANS_DEFAULT = 0.15
ANS_DEFAULT = 0.8

CHUNK_SIZE_WORDS = 900
CHUNK_OVERLAP_WORDS = 150

# -----------------------------
# FastAPI App
# -----------------------------

app = FastAPI(
    title="Query Fan-out & Embeddings API",
        version="0.3.0",
            description=(
                    "Takes a CSV of URL + query, generates fanout variants locally using FLAN-T5, "
                            "fetches + chunks the URL, computes similarity/coverage/answerability, and "
                                    "returns semantic embeddings."
                                        ),
                                            swagger_ui_parameters={"defaultModelsExpandDepth": -1},
                                            )

                                            app.add_middleware(
                                                CORSMiddleware,
                                                    allow_origins=["*"],
                                                        allow_credentials=True,
                                                            allow_methods=["*"],
                                                                allow_headers=["*"],
                                                                )

                                                                # -----------------------------
                                                                # Utility Functions
                                                                # -----------------------------

                                                                def _clean_text(s: str) -> str:
                                                                    return re.sub(r"\s+", " ", (s or "").strip())


                                                                    def important_terms(s: str) -> set:
                                                                        toks = [t.strip(".,!?()[]\"'`-_/").lower() for t in s.split()]
                                                                            return {t for t in toks if t and t not in ENGLISH_STOP_WORDS and len(t) > 2}


                                                                            def coverage_ratio(prompt: str, text: str) -> float:
                                                                                p = important_terms(prompt)
                                                                                    if not p:
                                                                                            return 0.0
                                                                                                t = important_terms(text)
                                                                                                    return min(1.0, len(p & t) / len(p))


                                                                                                    def chunk_text_words(text: str, max_words=CHUNK_SIZE_WORDS, overlap=CHUNK_OVERLAP_WORDS):
                                                                                                        words = text.split()
                                                                                                            if not words:
                                                                                                                    return []

                                                                                                                        chunks = []
                                                                                                                            step = max(1, max_words - overlap)
                                                                                                                                i = 0
                                                                                                                                    while i < len(words):
                                                                                                                                            chunks.append(" ".join(words[i:i + max_words]))
                                                                                                                                                    i += step
                                                                                                                                                        return chunks


                                                                                                                                                        @lru_cache(maxsize=64)
                                                                                                                                                        def fetch_main_text(url: str) -> str:
                                                                                                                                                            downloaded = trafilatura.fetch_url(url, no_ssl=True)
                                                                                                                                                                if not downloaded:
                                                                                                                                                                        return ""
                                                                                                                                                                            extracted = trafilatura.extract(downloaded, include_comments=False, include_formatting=False)
                                                                                                                                                                                return _clean_text(extracted or "")


                                                                                                                                                                                # -----------------------------
                                                                                                                                                                                # Local Model Loading
                                                                                                                                                                                # -----------------------------

                                                                                                                                                                                @lru_cache
                                                                                                                                                                                def get_embed_model():
                                                                                                                                                                                    return SentenceTransformer(EMBED_MODEL_PATH)


                                                                                                                                                                                    @lru_cache
                                                                                                                                                                                    def get_fanout_model():
                                                                                                                                                                                        tokenizer = AutoTokenizer.from_pretrained(FANOUT_MODEL_PATH)
                                                                                                                                                                                            model = AutoModelForSeq2SeqLM.from_pretrained(FANOUT_MODEL_PATH)
                                                                                                                                                                                                model.eval()
                                                                                                                                                                                                    return tokenizer, model


                                                                                                                                                                                                    # -----------------------------
                                                                                                                                                                                                    # Fanout Generation
                                                                                                                                                                                                    # -----------------------------

                                                                                                                                                                                                    def generate_fanouts(base_query: str, k: int) -> list:
                                                                                                                                                                                                        """
                                                                                                                                                                                                            Generate k query variants for a given base query using the local FLAN-T5 model.
                                                                                                                                                                                                                Returns a clean list of plain-text queries (no instructions, no numbering).
                                                                                                                                                                                                                    """
                                                                                                                                                                                                                        base_query = base_query.strip()
                                                                                                                                                                                                                            if not base_query or k <= 0:
                                                                                                                                                                                                                                    return []

                                                                                                                                                                                                                                        tokenizer, model = get_fanout_model()

                                                                                                                                                                                                                                            # Instruction-style prompt for FLAN-T5
                                                                                                                                                                                                                                                prompt = (
                                                                                                                                                                                                                                                        "You are an SEO assistant that rewrites a search query into closely related variants.\n"
                                                                                                                                                                                                                                                                f"Original query: \"{base_query}\"\n\n"
                                                                                                                                                                                                                                                                        "Task:\n"
                                                                                                                                                                                                                                                                                f"- Create {k} different but closely related search queries a user might type when searching for the same thing.\n"
                                                                                                                                                                                                                                                                                        "- Keep each variant under 12 words.\n"
                                                                                                                                                                                                                                                                                                "- One variant per line.\n"
                                                                                                                                                                                                                                                                                                        "- Do NOT number the lines.\n"
                                                                                                                                                                                                                                                                                                                "- Do NOT repeat the original query exactly.\n"
                                                                                                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                                                                                                        inputs = tokenizer(prompt, return_tensors="pt", truncation=True, max_length=256)

                                                                                                                                                                                                                                                                                                                            with torch.no_grad():
                                                                                                                                                                                                                                                                                                                                    output_ids = model.generate(
                                                                                                                                                                                                                                                                                                                                                **inputs,
                                                                                                                                                                                                                                                                                                                                                            max_new_tokens=80,
                                                                                                                                                                                                                                                                                                                                                                        do_sample=True,
                                                                                                                                                                                                                                                                                                                                                                                    temperature=0.7,
                                                                                                                                                                                                                                                                                                                                                                                                num_return_sequences=1,
                                                                                                                                                                                                                                                                                                                                                                                                        )

                                                                                                                                                                                                                                                                                                                                                                                                            raw_text = tokenizer.decode(output_ids[0], skip_special_tokens=True).strip()

                                                                                                                                                                                                                                                                                                                                                                                                                # Split into lines; if the model dumped everything on one line, try splitting by commas as fallback
                                                                                                                                                                                                                                                                                                                                                                                                                    lines = [ln.strip() for ln in raw_text.splitlines() if ln.strip()]
                                                                                                                                                                                                                                                                                                                                                                                                                        if len(lines) == 1 and "," in lines[0]:
                                                                                                                                                                                                                                                                                                                                                                                                                                lines = [part.strip() for part in lines[0].split(",") if part.strip()]

                                                                                                                                                                                                                                                                                                                                                                                                                                    variants = []
                                                                                                                                                                                                                                                                                                                                                                                                                                        seen = set()
                                                                                                                                                                                                                                                                                                                                                                                                                                            base_lower = base_query.lower()

                                                                                                                                                                                                                                                                                                                                                                                                                                                for line in lines:
                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Strip leading bullets / numbering
                                                                                                                                                                                                                                                                                                                                                                                                                                                                cleaned = line.lstrip(" -â€¢\t0123456789.").strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if not cleaned:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            lower = cleaned.lower()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Filter obvious prompt echo / instruction junk
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if "return" in lower and "variant" in lower:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        continue
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if "one per line" in lower or "no numbering" in lower:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            continue
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if lower.startswith("query:"):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cleaned = cleaned[len("query:"):].strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            lower = cleaned.lower()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if not cleaned:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Skip exact repeat of base query
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if lower == base_lower:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # Deduplicate
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if lower in seen:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        seen.add(lower)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                variants.append(cleaned)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if len(variants) >= k:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    break

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Fallback: if the model completely misbehaved, don't add extra variants
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if not variants:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return []

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return variants


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Scoring + Embedding
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -----------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def precompute_chunk_vectors(embed_model, chunks):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if not chunks:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return np.zeros((0, 0), dtype=np.float32)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return embed_model.encode(chunks, normalize_embeddings=True, convert_to_numpy=True)


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        def score_single(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            url: str,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                base_query: str,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    variant: str,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        embed_model,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            url_cache: Dict[str, Tuple[List[str], np.ndarray]],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if url not in url_cache:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        text = fetch_main_text(url)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if not text:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return {"url": url, "base_query": base_query, "variant_query": variant, "error": "No content extracted"}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    chunks = chunk_text_words(text)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            vecs = precompute_chunk_vectors(embed_model, chunks)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    url_cache[url] = (chunks, vecs)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        chunks, vecs = url_cache[url]

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            q_vec = embed_model.encode(variant, normalize_embeddings=True, convert_to_numpy=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                q_vec = np.asarray(q_vec, dtype=np.float32)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    sims = vecs @ q_vec
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        best_i = int(np.argmax(sims))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            sim_raw = float(sims[best_i])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                sim = (sim_raw + 1) / 2

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    best_chunk = chunks[best_i]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cov = coverage_ratio(variant, best_chunk)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ans = ANS_DEFAULT

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                score = 100 * (W_SIM_DEFAULT * sim + W_COV_DEFAULT * cov + W_ANS_DEFAULT * ans)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "url": url,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "base_query": base_query,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "variant_query": variant,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "is_fanout": variant != base_query,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "sim": round(sim, 3),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "coverage": round(cov, 3),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "answerability": ans,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "score": round(score, 1),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "best_chunk_excerpt": best_chunk[:500] + ("..." if len(best_chunk) > 500 else ""),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "embedding": q_vec.tolist(),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -----------------------------
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Routes
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # -----------------------------

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        @app.get("/health")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        async def health():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return {"status": "ok"}


                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            @app.post("/analyze")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            async def analyze_csv(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                file: UploadFile = File(...),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    fanout_k: int = Query(5, ge=0, le=20),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                df = pd.read_csv(io.BytesIO(await file.read()))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            raise HTTPException(400, f"CSV read failed: {e}")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if not {"url", "query"}.issubset(df.columns):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        raise HTTPException(422, "CSV must contain columns: url, query")

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            embed_model = get_embed_model()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                url_cache = {}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    results = []

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for _, row in df.iterrows():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                url = str(row["url"]).strip()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        base = str(row["query"]).strip()

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                variants = [base]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if fanout_k > 0:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    try:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    variants += generate_fanouts(base, fanout_k)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                print("Fanout error:", e)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for vq in variants:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    results.append(score_single(url, base, vq, embed_model, url_cache))

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        meta = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "num_input_rows": len(df),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "num_output_rows": len(results),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "fanout_per_query": fanout_k,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        "embed_model": EMBED_MODEL_PATH,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                "fanout_model": FANOUT_MODEL_PATH,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return JSONResponse({"rows": results, "meta": meta})
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
